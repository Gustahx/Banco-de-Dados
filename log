CREATE DATABASE seguranca;

USE seguranca;

CREATE TABLE cliente (
	id INT AUTO_INCREMENT PRIMARY KEY,
	nome VARCHAR (500),
	cpf VARCHAR(15),
	telefone VARCHAR (15),
	endereco VARCHAR (1000)
);	  
 
 CREATE TABLE venda (
 	id INT AUTO_INCREMENT PRIMARY KEY,
 	dia DATETIME,
	valor FLOAT
);

INSERT INTO cliente (nome, cpf, telefone, endereco)	 
VALUES 
 ("Gustavo Daniel da Costa", "74185296300", "83987544566", "Rua que Ã© rua"),
 ("Vegetti","78965412311","84932165498","Rua da loucura");
 
SELECT * FROM cliente

CREATE TABLE venda_log (
  log_id INT AUTO_INCREMENT PRIMARY KEY,
  old_id INT,
  old_dia DATETIME, 
  old_valor FLOAT,
  new_id INT,
  new_dia DATETIME,
  new_valor FLOAT,
  acao VARCHAR(6),
  usuario VARCHAR (50),
  hora TIMESTAMP
);


 
CREATE TRIGGER venda_log_insert AFTER INSERT ON venda FOR EACH ROW 
INSERT INTO venda_log (old_id, old_dia, old_valor, new_id, new_dia, new_valor, acao, usuario, hora)
VALUES (NULL, NULL, NULL, NEW.id, NEW.dia, NEW.valor, "INSERT", USER(), NOW());

SELECT * FROM venda_log

INSERT INTO venda (dia, valor)
VALUES 
('2023-09-19', 250.50),
('2023-09-21', 130.0),
('2023-09-25', 1000.75),
('2023-09-25', 750.60),
('2023-09-26', 655.68);

SELECT * FROM venda_log

CREATE TRIGGER venda_log_update AFTER UPDATE ON venda FOR EACH ROW 
INSERT INTO venda_log(old_id, old_dia, old_valor, new_id, new_dia, new_valor, acao, usuario, hora) 
VALUES (OLD.id, OLD.dia, OLD.valor, NEW.id, NEW.dia, NEW.valor, "UPDATE", USER(), NOW());
	
UPDATE venda SET valor = 550.00 WHERE id = 3

SELECT * FROM venda 

SELECT * FROM venda_log

UPDATE venda SET valor = 650.00
WHERE id = 4

 SELECT * FROM venda
 
 SELECT * FROM venda_log

 CREATE TRIGGER venda_log_update AFTER DELETE ON venda FOR EACH ROW 
 INSERT INTO venda_log (old_id, old_dia, old_valor, new_id, new_dia, new_valor, acao, usuario, hora)
 VALUES (OLD.id, OLD.dia, OLD.valor, NULL, NULL, NULL, 'DELETE', USER(), NOW());
 
 SELECT * FROM venda
 
 SELECT * FROM venda_log 
 
 DELETE FORM venda WHERE id = 4
 
 
 
 
 
 CREATE USER 'gustavo'@'localhost' IDENTIFIED BY '741852'
 
 GRANT ALL PRIVILEGES ON * TO 'gustavo'@'localhost'
 
 
SELECT CURRENT_USER()
SELECT USER FROM mysql.user


SELECT * FROM venda_log
